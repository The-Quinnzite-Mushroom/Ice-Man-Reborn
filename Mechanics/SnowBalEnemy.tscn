[gd_scene load_steps=7 format=3 uid="uid://bxw7kpfudeajs"]

[ext_resource type="Texture2D" uid="uid://jmctairgaw8n" path="res://art/new_snow_man.png" id="1_wawgv"]

[sub_resource type="GDScript" id="GDScript_745ot"]
script/source = "extends Moving_Enemy

@onready var timer: Timer = $Timer
const SNOWBALL_SCENE: PackedScene = preload(\"res://Mechanics/snowball.tscn\")
@export var homing: bool = true
@export var throw_speed: float = 700
@export var random_throw_angle_range: float = 45
@export var lock_on_node: Node2D
var thrown: bool = false
var can_throw: bool = false

@export var timer_seconds = 1.0

func _ready() -> void:
	timer.wait_time = timer_seconds

func _physics_process(_delta: float) -> void:
	if can_throw and not thrown:
		if homing:
			if is_lock_on_object():
				lock_in_object(lock_on_node)
				return
			var player = get_player()
			if player:
				lock_in_object(player)
				return
		else:
			throw_randomly()
		

func lock_in_object(node):
	var to_node_direction = (node.global_position - global_position).normalized()
	var velocity = to_node_direction * throw_speed
	fire_snowball(velocity)
	
func throw_randomly():
	var angle_degrees = randf() * random_throw_angle_range - random_throw_angle_range / 2
	var angle_radians = deg_to_rad(angle_degrees)
	var velocity = Vector2(throw_speed, 0).rotated(angle_radians)
	fire_snowball(velocity)
	
func is_lock_on_object():
	if lock_on_node:
		return true
	return false

func get_player():
	var all_nodes = get_tree().get_nodes_in_group(\"Player\")
	if all_nodes.size() > 0:
		return all_nodes[0]
	return null

func fire_snowball(init_velocity: Vector2):
	$Sprite2d.flip_h = init_velocity.x < 0
	$AnimationPlayer.play(\"throw\")
	var instance = SNOWBALL_SCENE.instantiate()
	add_child(instance)
	instance.global_position = global_position
	instance.scale /= 2
	instance.velocity = init_velocity
	instance.velocity.y -= 50
	thrown = true
	
func _on_timer_timeout() -> void:
	if can_throw:
		can_throw = false
		return
	can_throw = true
	thrown = false
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_au7ya"]
size = Vector2(12, 20)

[sub_resource type="Animation" id="Animation_dwtpo"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Sprite2d:frame")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 1,
"values": [0]
}

[sub_resource type="Animation" id="Animation_au7ya"]
resource_name = "throw"
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Sprite2d:frame")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.1, 0.19999999, 0.3, 0.43333334, 0.6),
"transitions": PackedFloat32Array(1, 1, 1, 1, 1, 1),
"update": 1,
"values": [0, 1, 2, 3, 4, 5]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_hfftk"]
_data = {
&"RESET": SubResource("Animation_dwtpo"),
&"throw": SubResource("Animation_au7ya")
}

[node name="SnowBalEnemy" type="RigidBody2D"]
gravity_scale = 5.0
script = SubResource("GDScript_745ot")

[node name="Sprite2d" type="Sprite2D" parent="."]
texture_filter = 1
texture = ExtResource("1_wawgv")
hframes = 6

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(0, 6)
shape = SubResource("RectangleShape2D_au7ya")

[node name="Timer" type="Timer" parent="."]
autostart = true

[node name="RayCast2D" type="RayCast2D" parent="."]
position = Vector2(0, 6)
target_position = Vector2(-11, 0)

[node name="RayCast2D2" type="RayCast2D" parent="."]
position = Vector2(0, 6)
target_position = Vector2(10, 0)

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
&"": SubResource("AnimationLibrary_hfftk")
}

[connection signal="timeout" from="Timer" to="." method="_on_timer_timeout"]
